# 自动填充功能实现任务清单

## 📋 任务概览
本任务清单将自动填充功能分解为可验证、独立的工作项，确保开发过程可控且用户可见。

## 🎯 Phase 1: 数据模型和配置管理

### 1.1 创建自动填充配置数据模型
**任务**: 定义 `AutoFillConfig` TypeScript 接口
- **文件**: `src/types/autoFill.ts` (新建)
- **内容**:
  ```typescript
  interface AutoFillConfig {
    containerSelector: string
    fieldMappings: Array<{
      label: string
      value: string
    }>
  }
  ```
- **验证**: 接口定义准确反映规格要求
- **依赖**: 无
- **预估时间**: 30分钟

### 1.2 创建配置存储管理composable
**任务**: 实现 `useAutoFillSettings` composable
- **文件**: `src/composables/useAutoFillSettings.ts` (新建)
- **功能**:
  - 从 `browser.storage.local` 读取配置
  - 保存配置到存储
  - 提供默认配置（空选择器，空映射）
  - 验证配置格式
- **验证**: 配置读写正常，验证逻辑正确
- **依赖**: 1.1
- **预估时间**: 1小时

## 🎨 Phase 2: 设置页面UI实现

### 2.1 创建键值对输入组件
**任务**: 实现 `KeyValueInput` 组件
- **文件**: `src/popup/components/KeyValueInput.vue` (新建)
- **功能**:
  - 显示标签输入框和值输入框
  - 提供删除按钮
  - 支持键盘导航
  - 输入验证（非空检查）
- **验证**: 组件可独立测试，UI符合设计规范
- **依赖**: 无
- **预估时间**: 1.5小时

### 2.2 更新SettingsPage.vue添加自动填充配置区域
**任务**: 在设置页面集成自动填充配置
- **文件**: `src/popup/SettingsPage.vue` (修改)
- **功能**:
  - 在现有设置下方添加"自动填充配置"标题
  - 添加容器选择器输入框（使用BaseInput）
  - 添加键值对列表（使用KeyValueInput）
  - 添加"添加键值对"按钮
  - 更新保存和重置逻辑以包含自动填充配置
- **验证**: UI显示正确，与现有设置样式一致
- **依赖**: 2.1, 1.2
- **预估时间**: 2小时

### 2.3 添加配置验证和错误处理
**任务**: 实现配置验证逻辑
- **文件**: `src/popup/SettingsPage.vue` (修改)
- **功能**:
  - 验证容器选择器基本CSS语法（使用简单的正则）
  - 验证键值对列表不为空且每项都填写完整
  - 显示具体的错误提示消息
  - 阻止保存无效配置
- **验证**: 验证规则正确，错误提示清晰
- **依赖**: 2.2
- **预估时间**: 1小时

## ⚡ Phase 3: Popup UI 实现

### 3.1 创建自动填充SVG图标
**任务**: 设计并创建自动填充图标
- **文件**: `src/popup/components/icons/AutoFillIcon.vue` (新建)
- **设计**: 简洁的表单填充图标（文档+箭头）
- **规格**: 24x24px，支持isActive和hasError状态的变色
- **验证**: 图标清晰可识别，与现有图标风格一致
- **依赖**: 无
- **预估时间**: 30分钟

### 3.2 更新Popup.vue添加自动填充按钮
**任务**: 在图标栏集成自动填充按钮
- **文件**: `src/popup/Popup.vue` (修改)
- **功能**:
  - 在"屏蔽广告"按钮后添加自动填充按钮
  - 调整图标栏布局以容纳4个按钮
  - 绑定点击事件处理函数
  - 支持按钮状态显示（加载/成功/错误）
- **验证**: 按钮位置正确，布局美观，响应正常
- **依赖**: 3.1
- **预估时间**: 1小时

### 3.3 实现自动填充交互逻辑
**任务**: 实现按钮点击处理函数
- **文件**: `src/popup/Popup.vue` (修改)
- **功能**:
  - 从存储读取自动填充配置
  - 验证配置存在且有效
  - 获取当前活动标签页
  - 发送消息到内容脚本执行填充
  - 处理执行结果并显示反馈消息
  - 管理按钮状态变化
- **验证**: 交互流程完整，错误处理健全
- **依赖**: 3.2, 1.2
- **预估时间**: 1.5小时

## 🚀 Phase 4: 内容脚本实现

### 4.1 创建内容脚本消息监听器
**任务**: 在内容脚本中添加消息监听
- **文件**: `src/contentScripts/` (新建或修改现有)
- **功能**:
  - 监听来自popup的 `EXECUTE_AUTO_FILL` 消息
  - 验证消息格式和权限
  - 调用自动填充执行函数
  - 返回执行结果（成功数、失败数等）
- **验证**: 消息通信正常，安全性检查通过
- **依赖**: 无
- **预估时间**: 1小时

### 4.2 实现自动填充核心算法
**任务**: 实现表单填充逻辑
- **文件**: `src/contentScripts/autoFill.ts` (新建)
- **功能**:
  - 接收容器选择器和键值对映射
  - 查找容器内的所有 `.el-form-item` 元素
  - 对每个元素验证恰好2个子元素，否则忽略
  - 提取第一个子元素的文本，trim并移除冒号
  - 根据处理后的文本匹配键值对key
  - 在第二个子元素中查找input并设置value
  - 返回统计结果（总数量、匹配数量、填充数量）
- **验证**: 算法符合规格，容错性强，性能良好
- **依赖**: 4.1
- **预估时间**: 2小时

### 4.3 添加安全和性能优化
**任务**: 添加安全检查和性能优化
- **文件**: `src/contentScripts/autoFill.ts` (修改)
- **功能**:
  - 限制只在http/https协议页面执行
  - 添加敏感字段过滤（password, creditCard等）
  - 使用CSS选择器优化查询性能
  - 添加执行超时机制（防止长时间阻塞）
- **验证**: 安全检查有效，性能指标良好
- **依赖**: 4.2
- **预估时间**: 1小时

## 🔧 Phase 5: 集成和测试

### 5.1 更新manifest配置
**任务**: 添加内容脚本配置
- **文件**: `manifest.ts` (修改)
- **功能**:
  - 添加内容脚本条目
  - 配置脚本匹配规则（匹配调试页面）
  - 添加必要的权限（storage, tabs, activeTab）
- **验证**: 扩展安装正常，权限正确
- **依赖**: 4.3
- **预估时间**: 30分钟

### 5.2 端到端功能测试
**任务**: 完整功能测试
- **环境**: 本地开发环境
- **测试场景**:
  1. 打开设置页面，配置容器选择器和键值对
  2. 保存配置并验证数据存储
  3. 打开包含Element UI表单的测试页面
  4. 点击popup中的自动填充按钮
  5. 验证表单正确填充
  6. 测试错误场景（无效选择器、空配置等）
- **验证**: 所有测试用例通过
- **依赖**: 5.1
- **预估时间**: 1.5小时

### 5.3 代码审查和优化
**任务**: 代码质量检查
- **范围**: 所有新增和修改的文件
- **检查项**:
  - TypeScript类型安全
  - Vue 3组合式API规范
  - 代码复用和DRY原则
  - 错误处理和边界情况
  - 性能优化机会
- **验证**: 代码质量达标，符合项目规范
- **依赖**: 5.2
- **预估时间**: 1小时

## 📦 交付物清单

### 新建文件
- [ ] `src/types/autoFill.ts` - 数据模型
- [ ] `src/composables/useAutoFillSettings.ts` - 配置管理
- [ ] `src/popup/components/KeyValueInput.vue` - 键值对组件
- [ ] `src/popup/components/icons/AutoFillIcon.vue` - 图标组件
- [ ] `src/contentScripts/autoFill.ts` - 填充逻辑
- [ ] `openspec/changes/2025-11-20-add-auto-fill/*` - 完整规格文档

### 修改文件
- [ ] `src/popup/Popup.vue` - 添加自动填充按钮和交互
- [ ] `src/popup/SettingsPage.vue` - 添加自动填充配置区域
- [ ] `manifest.ts` - 添加内容脚本配置

### 测试验证
- [ ] 所有TypeScript类型检查通过
- [ ] 所有ESLint规则通过
- [ ] 手动功能测试通过
- [ ] OpenSpec规格验证通过

## ⚠️ 风险和依赖

### 外部依赖
- Element UI表单类名 `.el-form-item` 的依赖
- 测试页面需要可访问和可预测的结构

### 技术风险
- 内容脚本与popup的通信可靠性
- 复杂页面结构下的填充准确性
- 性能在大量表单字段下的表现

### 缓解策略
- 添加充分的错误处理和fallback机制
- 使用CSS选择器优化而非递归遍历
- 添加用户确认机制和安全限制

## 🎉 成功标准

1. ✅ 所有任务完成并通过验证
2. ✅ 设置页面可以配置容器选择器和键值对
3. ✅ popup页面显示自动填充按钮并可点击
4. ✅ 点击按钮后正确填充目标表单
5. ✅ 错误场景有清晰的用户提示
6. ✅ 代码符合项目质量和风格标准
7. ✅ OpenSpec文档完整且通过验证

**总预估时间**: 14.5小时
**并行任务数**: 部分任务可并行（Phase 1和Phase 3）
**实际交付时间**: 约10-12小时（考虑并行和优化）
